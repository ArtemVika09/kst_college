import logging
import random
import os
import json
import sys
import time
from datetime import datetime
from pathlib import Path
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, MenuButtonCommands, ReplyKeyboardMarkup, KeyboardButton, BotCommand
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, filters
from telegram.error import TimedOut, NetworkError, RetryAfter, Conflict

# –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π —Ä–∞–±–æ—Ç—ã —Å –ë–î
import database

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: name -> __name__

# –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ (–±–µ—Ä–µ—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
TOKEN = os.getenv('BOT_TOKEN', '8387232890:AAGDhHOREkXmN58idiP8tgBWWLVF9mgCdZ8')
# –ï—Å–ª–∏ —É–∫–∞–∑–∞—Ç—å BOT_OWNER_ID (—á–∏—Å–ª–æ), /restart –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É
BOT_OWNER_ID = int(os.getenv("BOT_OWNER_ID", "0") or "0")

# –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ –±–æ—Ç–∞ (–¥–ª—è –∫–æ–Ω—Ñ–∏–≥–æ–≤ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
BOT_DIR = Path(__file__).resolve().parent
CONFIG_DIR = BOT_DIR / "config"
RATINGS_FILE = CONFIG_DIR / "ratings.json"
WEEKLY_POLL_FILE = CONFIG_DIR / "weekly_poll.json"
# –§–æ—Ç–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –æ–±–µ–¥–æ–≤: –ø–æ–ª–æ–∂–∏—Ç–µ —Ñ–∞–π–ª lunch_schedule.png –≤ –ø–∞–ø–∫—É —Å –±–æ—Ç–æ–º
LUNCH_SCHEDULE_IMAGE = BOT_DIR / "lunch_schedule.png"

# –ì—Ä—É–ø–ø—ã –¥–ª—è –æ–ø—Ä–æ—Å–æ–≤ (—Å—Ç—É–¥–µ–Ω—Ç—ã)
STUDENT_GROUPS = ["–°–ò–ü-113/25", "–°–ò–ü-123/25", "–°–ò–ü-133/25", "–°–ò–ü-143/25"]

# –ö–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –ü–ï–î–ê–ì–û–ì–ê–ú (–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±–µ–∑ –∫–æ–¥–∞)
PEDAGOG_CODE = (os.getenv("PEDAGOG_CODE", "") or "").strip()

# ========== –ë–ê–ó–ê –î–ê–ù–ù–´–• SQLite ==========
# –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –ë–î –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –º–æ–¥—É–ª—å database.py

# ========== FAQ –¥–ª—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤ (–≤–æ–ø—Ä–æ—Å ‚Äî –æ—Ç–≤–µ—Ç) ==========
# –í–æ–ø—Ä–æ—Å ‚Äî –æ—Ç–≤–µ—Ç; –∫–Ω–æ–ø–∫–∞ —Å –≤–æ–ø—Ä–æ—Å–æ–º, –ø–æ –Ω–∞–∂–∞—Ç–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç
FAQ_ITEMS = [
    ("–ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è?", "–î–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –Ω—É–∂–Ω—ã: –ø–∞—Å–ø–æ—Ä—Ç, –∞—Ç—Ç–µ—Å—Ç–∞—Ç (–∏–ª–∏ —Å–ø—Ä–∞–≤–∫–∞ –æ–± –æ–±—É—á–µ–Ω–∏–∏), —Ñ–æ—Ç–æ 3√ó4, –∑–∞—è–≤–ª–µ–Ω–∏–µ. –¢–æ—á–Ω—ã–π –ø–µ—Ä–µ—á–µ–Ω—å —É—Ç–æ—á–Ω—è–π—Ç–µ –≤ –ø—Ä–∏—ë–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏."),
    ("–ö–∞–∫–æ–π –ø—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª?", "–ü—Ä–æ—Ö–æ–¥–Ω—ã–µ –±–∞–ª–ª—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –≥–æ–¥–∞. –ê–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ –∫–æ–ª–ª–µ–¥–∂–∞ –∏–ª–∏ –≤ –ø—Ä–∏—ë–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏."),
    ("–ï—Å—Ç—å –ª–∏ –æ–±—â–µ–∂–∏—Ç–∏–µ?", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–ª–∏—á–∏–∏ –º–µ—Å—Ç –≤ –æ–±—â–µ–∂–∏—Ç–∏–∏ —É—Ç–æ—á–Ω—è–π—Ç–µ –≤ –ø—Ä–∏—ë–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏ –∏–ª–∏ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º —Å–∞–π—Ç–µ –∫–æ–ª–ª–µ–¥–∂–∞."),
    ("–ú–æ–∂–Ω–æ –ª–∏ –ø–æ—Å—Ç—É–ø–∏—Ç—å –ø–æ—Å–ª–µ 9 –∫–ª–∞—Å—Å–∞?", "–î–∞, –≤ –∫–æ–ª–ª–µ–¥–∂ –º–æ–∂–Ω–æ –ø–æ—Å—Ç—É–ø–∏—Ç—å –Ω–∞ –±–∞–∑–µ 9 –∏–ª–∏ 11 –∫–ª–∞—Å—Å–æ–≤. –ü–µ—Ä–µ—á–µ–Ω—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π –∏ —Å—Ä–æ–∫–∏ –æ–±—É—á–µ–Ω–∏—è —É—Ç–æ—á–Ω—è–π—Ç–µ –≤ –ø—Ä–∏—ë–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏."),
    ("–ö–æ–≥–¥–∞ –¥–Ω–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π?", "–î–∞—Ç—ã –¥–Ω–µ–π –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ –∏ –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö –∫–æ–ª–ª–µ–¥–∂–∞. –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑–¥–µ–ª ¬´–î–Ω–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π¬ª –≤ —ç—Ç–æ–º –±–æ—Ç–µ."),
    ("–ö–∞–∫ –ø–æ–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –æ–Ω–ª–∞–π–Ω?", "–ê–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∏ —Å—Ä–æ–∫–∏ –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–≤ —Ç–æ–º —á–∏—Å–ª–µ –æ–Ω–ª–∞–π–Ω) —Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ –∫–æ–ª–ª–µ–¥–∂–∞ –∏ –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤¬ª –≤ —ç—Ç–æ–º –±–æ—Ç–µ."),
]

# ========== –ö–ê–ù–ê–õ –î–õ–Ø –û–ë–™–Ø–í–õ–ï–ù–ò–ô ==========
ANNOUNCEMENTS_CHANNEL_LINK = "https://t.me/kst_announcements"
ANNOUNCEMENTS_CHANNEL_USERNAME = "@KST ANNOUNCEMENTS"

# ========== –ö–ê–ù–ê–õ –î–õ–Ø –õ–ï–ù–¢–´ –ù–û–í–û–°–¢–ï–ô –ê–ë–ò–¢–£–†–ò–ï–ù–¢–û–í ==========
NEWS_FEED_CHANNEL_LINK = "https://t.me/kst_abiturient_news"
NEWS_FEED_CHANNEL_USERNAME = "@KST_ABITURIENTS_NEWS"

# ========== –ß–ê–¢ –ö–°–¢ ==========
CHAT_LINK = "https://t.me/+-7B5mbs8eOo2YmJi"

# ========== –î–ù–ò –û–¢–ö–†–´–¢–´–• –î–í–ï–†–ï–ô ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∏ (–¥–∞—Ç–∞, –∑–∞–≥–æ–ª–æ–≤–æ–∫, –æ–ø–∏—Å–∞–Ω–∏–µ, –∫–∞—Ä—Ç–∏–Ω–∫–∞) ==========
# image_url ‚Äî —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (HTTP/HTTPS) –∏–ª–∏ None (–∫–∞—Ä—Ç–æ—á–∫–∞ –±–µ–∑ —Ñ–æ—Ç–æ)
# image_path ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–∞–ø–∫–∏ –±–æ—Ç–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä "open_doors/1.jpg"
OPEN_DOORS_CARDS = [
    {
        "date": "15 –º–∞—Ä—Ç–∞ 2025",
        "title": "–î–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π –≤ –ö–°–¢",
        "description": "–ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –∫–æ–ª–ª–µ–¥–∂–µ–º, —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—è–º–∏, —ç–∫—Å–∫—É—Ä—Å–∏–∏ –ø–æ –∞—É–¥–∏—Ç–æ—Ä–∏—è–º –∏ –º–∞—Å—Ç–µ—Ä—Å–∫–∏–º. –í—Å—Ç—Ä–µ—á–∞ —Å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏.",
        "image_url": "https://placehold.co/600x400/2563eb/white?text=15+–º–∞—Ä—Ç–∞+2025",
    },
    {
        "date": "12 –∞–ø—Ä–µ–ª—è 2025",
        "title": "–î–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π ‚Äî –≤–µ—Å–Ω–∞",
        "description": "–û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –∏ —É—á—ë–±–µ. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Å–∞–π—Ç–µ –∏–ª–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –ø—Ä–∏—ë–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏.",
        "image_url": "https://placehold.co/600x400/059669/white?text=12+–∞–ø—Ä–µ–ª—è+2025",
    },
    {
        "date": "17 –º–∞—è 2025",
        "title": "–§–∏–Ω–∞–ª—å–Ω—ã–π –¥–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π",
        "description": "–ü–æ—Å–ª–µ–¥–Ω—è—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤ —ç—Ç–æ–º —É—á–µ–±–Ω–æ–º –≥–æ–¥—É –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –∫–æ–ª–ª–µ–¥–∂–µ–º –ø–µ—Ä–µ–¥ –ø—Ä–∏—ë–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–µ–π.",
        "image_url": None,  # –±–µ–∑ –∫–∞—Ä—Ç–∏–Ω–∫–∏ ‚Äî –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ URL –∏–ª–∏ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
    },
]
# –ü–∞–ø–∫–∞ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∫–∞—Ä—Ç–æ—á–µ–∫ (—Ä—è–¥–æ–º —Å –±–æ—Ç–æ–º)
OPEN_DOORS_IMAGES_DIR = BOT_DIR / "open_doors"

# ========== –ë–ê–ó–ê –î–ê–ù–ù–´–• –ü–†–ï–î–°–ö–ê–ó–ê–ù–ò–ô ==========
# –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
PREDICTION_CATEGORIES = {
    "—É—á–µ–±–∞": [
        "–°–µ–≥–æ–¥–Ω—è —Ç—ã –ø–æ–ª—É—á–∏—à—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—É—é '5' –Ω–∞ –ø–∞—Ä–µ",
        "–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞—Å—Ç –≤–æ–ø—Ä–æ—Å, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç–æ–ª—å–∫–æ —Ç—ã –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç",
        "–¢–≤–æ—è –¥–æ–º–∞—à–Ω—è—è —Ä–∞–±–æ—Ç–∞ –æ–∫–∞–∂–µ—Ç—Å—è —Å–∞–º–æ–π –ª—É—á—à–µ–π –≤ –≥—Ä—É–ø–ø–µ",
        "–ù–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –ø–æ–ø–∞–¥–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ —Ç–æ—Ç –±–∏–ª–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –ø–æ–≤—Ç–æ—Ä–∏–ª",
        "–°–æ–∫—É—Ä—Å–Ω–∏–∫ –ø–æ–ø—Ä–æ—Å–∏—Ç —É —Ç–µ–±—è –ø–æ–º–æ—â–∏ —Å –∑–∞–¥–∞–Ω–∏–µ–º",
        "–¢—ã –æ—Ç–∫—Ä–æ–µ—à—å –Ω–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –∫–æ–Ω—Å–ø–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è",
        "–õ–µ–∫—Ü–∏—è –æ–∫–∞–∂–µ—Ç—Å—è –Ω–∞–º–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ, —á–µ–º —Ç—ã –æ–∂–∏–¥–∞–ª",
        "–¢—ã –Ω–∞–π–¥–µ—à—å –æ—à–∏–±–∫—É –≤ —É—á–µ–±–Ω–∏–∫–µ –∏ –ø–æ–ª—É—á–∏—à—å –∑–∞ —ç—Ç–æ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å"
    ],
    "–æ—Ç–Ω–æ—à–µ–Ω–∏—è": [
        "–¢—ã –≤—Å—Ç—Ä–µ—Ç–∏—à—å —Å—Ç–∞—Ä–æ–≥–æ –¥—Ä—É–≥–∞ –∏–∑ –¥—Ä—É–≥–æ–π –≥—Ä—É–ø–ø—ã",
        "–ö—Ç–æ-—Ç–æ –∏–∑ –æ–¥–Ω–æ–≥—Ä—É–ø–ø–Ω–∏–∫–æ–≤ —Å–¥–µ–ª–∞–µ—Ç —Ç–µ–±–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç",
        "–¢—ã –ø–æ–º–∏—Ä–∏—à—å—Å—è —Å —Ç–µ–º, —Å –∫–µ–º –¥–∞–≤–Ω–æ –±—ã–ª –≤ —Å—Å–æ—Ä–µ",
        "–ù–∞ –ø–µ—Ä–µ–º–µ–Ω–µ –∑–∞–≤–µ–¥–µ—à—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –Ω–æ–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º",
        "–¢–µ–±–µ –ø—Ä–∏–∑–Ω–∞—é—Ç—Å—è –≤ —É–≤–∞–∂–µ–Ω–∏–∏, –æ –∫–æ—Ç–æ—Ä–æ–º —Ç—ã –Ω–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–ª",
        "–ö–æ–ª–ª–µ–≥–∞ –ø–æ —É—á–µ–±–µ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç —Ç–µ–±—è –Ω–∞ —Å–æ–≤–º–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç"
    ],
    "—É–¥–∞—á–∞": [
        "–¢—ã –Ω–∞–π–¥–µ—à—å –ø–æ—Ç–µ—Ä—è–Ω–Ω—É—é –≤–µ—â—å, –∫–æ—Ç–æ—Ä—É—é –¥–∞–≤–Ω–æ –∏—Å–∫–∞–ª",
        "–ù–∞ —Å—Ç–æ–ª–æ–≤–æ–π —Ç–µ–±–µ –¥–æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–∏—Ä–æ–∂–æ–∫",
        "–ê–≤—Ç–æ–±—É—Å –ø—Ä–∏–µ–¥–µ—Ç –∏–º–µ–Ω–Ω–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ —Ç—ã –ø–æ–¥–æ–π–¥–µ—à—å –∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ",
        "–¢—ã –≤—ã–∏–≥—Ä–∞–µ—à—å –≤ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–π –ª–æ—Ç–µ—Ä–µ–µ",
        "–¢–µ–±–µ —É—Å—Ç—É–ø—è—Ç –º–µ—Å—Ç–æ –≤ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏",
        "–ù–∞–π–¥–µ—à—å –¥–µ–Ω—å–≥–∏ –≤ —Å—Ç–∞—Ä–æ–π –∫—É—Ä—Ç–∫–µ"
    ],
    "—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ": [
        "–ö —Ç–µ–±–µ –ø—Ä–∏–¥–µ—Ç –≥–µ–Ω–∏–∞–ª—å–Ω–∞—è –∏–¥–µ—è –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞",
        "–¢—ã –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ –ø—Ä–æ—è–≤–∏—à—å —Ç–∞–ª–∞–Ω—Ç –≤ —Ç–æ–º, —á–µ–≥–æ —Ä–∞–Ω—å—à–µ –Ω–µ –ø—Ä–æ–±–æ–≤–∞–ª",
        "–¢–≤–æ–µ —Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ —É–¥–∏–≤–∏—Ç –¥–∞–∂–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è",
        "–¢—ã –Ω–∞–π–¥–µ—à—å –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –≤ —Å–∞–º–æ–º –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º –º–µ—Å—Ç–µ",
        "–°–æ–∫—É—Ä—Å–Ω–∏–∫–∏ –æ—Ü–µ–Ω—è—Ç —Ç–≤–æ—é –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å"
    ],
    "–∑–¥–æ—Ä–æ–≤—å–µ": [
        "–¢—ã –æ—Ç–∫—Ä–æ–µ—à—å –¥–ª—è —Å–µ–±—è –Ω–æ–≤—ã–π –ø–æ–ª–µ–∑–Ω—ã–π –ø–µ—Ä–µ–∫—É—Å –≤ —Å—Ç–æ–ª–æ–≤–æ–π",
        "–ü—Ä–æ–±–µ–∂–∫–∞ –º–µ–∂–¥—É –∫–æ—Ä–ø—É—Å–∞–º–∏ –∑–∞—Ä—è–¥–∏—Ç —Ç–µ–±—è —ç–Ω–µ—Ä–≥–∏–µ–π –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å",
        "–¢—ã –Ω–∞–π–¥–µ—à—å –∏–¥–µ–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –æ—Ç–¥—ã—Ö–∞ –º–µ–∂–¥—É –ø–∞—Ä–∞–º–∏",
        "–û—Ç–∫—Ä–æ–µ—à—å –Ω–æ–≤—ã–π —Å–ø–æ—Å–æ–± —Å–Ω—è—Ç—å —Å—Ç—Ä–µ—Å—Å –ø–µ—Ä–µ–¥ —ç–∫–∑–∞–º–µ–Ω–æ–º"
    ],
    "—Ñ–∏–Ω–∞–Ω—Å—ã": [
        "–¢–µ–±–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ –≤–µ—Ä–Ω—É—Ç —Å—Ç–∞—Ä—ã–π –¥–æ–ª–≥",
        "–ù–∞–π–¥–µ—à—å —Å–ø–æ—Å–æ–± —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å –Ω–∞ –æ–±–µ–¥–∞—Ö",
        "–ü–æ–ª—É—á–∏—à—å –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ –ø–æ–¥—Ä–∞–±–æ—Ç–∫–µ",
        "–¢–µ–±–µ —Å–¥–µ–ª–∞—é—Ç —Å–∫–∏–¥–∫—É –≤ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–π —Å—Ç–æ–ª–æ–≤–æ–π"
    ],
    "—Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∞—è –∂–∏–∑–Ω—å": [
        "–¢–µ–±—è –ø—Ä–∏–≥–ª–∞—Å—è—Ç –Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –≤ –∫–æ–ª–ª–µ–¥–∂–µ",
        "–£–∑–Ω–∞–µ—à—å —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ –º–µ—Å—Ç–æ –≤ –æ–±—â–µ–∂–∏—Ç–∏–∏",
        "–°—Ç–∞–Ω–µ—à—å —Å–≤–∏–¥–µ—Ç–µ–ª–µ–º –∑–∞–±–∞–≤–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –≤ –∫–æ—Ä–∏–¥–æ—Ä–µ",
        "–£—á–∞—Å—Ç–≤—É–µ—à—å –≤ —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ–π —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–π –∞–∫—Ü–∏–∏"
    ],
    "–±—É–¥—É—â–µ–µ": [
        "–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ —Ç–≤–æ—é –±—É–¥—É—â—É—é –ø—Ä–æ—Ñ–µ—Å—Å–∏—é",
        "–¢—ã –ø–æ–ª—É—á–∏—à—å –∑–Ω–∞–∫, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç –≤ –≤—ã–±–æ—Ä–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏",
        "–í—Å—Ç—Ä–µ—á–∞ –∏–∑–º–µ–Ω–∏—Ç —Ç–≤–æ–∏ –ø–ª–∞–Ω—ã –Ω–∞ —Å–µ–º–µ—Å—Ç—Ä",
        "–¢—ã –ø–æ–π–º–µ—à—å, –∫–∞–∫–∏–º –ø—É—Ç–µ–º —Ö–æ—á–µ—à—å —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ"
    ]
}

# –ú—É–¥—Ä—ã–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
STUDENT_TIPS = [
    "–ù–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–π –Ω–∞ –∑–∞–≤—Ç—Ä–∞ —Ç–æ, —á—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –º–µ–∂–¥—É –ø–∞—Ä–∞–º–∏",
    "–°–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è –ø–∞—Ä–∞ ‚Äî —ç—Ç–æ –ø–µ—Ä–≤–∞—è, –¥–∞–ª—å—à–µ –±—É–¥–µ—Ç –ª–µ–≥—á–µ",
    "–ö–æ–Ω—Å–ø–µ–∫—Ç–∏—Ä—É–π –Ω–µ –≤—Å—ë –ø–æ–¥—Ä—è–¥, –∞ —Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω–æ–µ",
    "–õ—É—á—à–∏–π –¥—Ä—É–≥ —Å—Ç—É–¥–µ–Ω—Ç–∞ ‚Äî —ç—Ç–æ —Ç–µ—Ä–º–æ—Å —Å –∫–æ—Ñ–µ",
    "–ù–µ –±–æ–π—Å—è –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã ‚Äî —á–∞—â–µ –≤—Å–µ–≥–æ –æ–Ω–∏ —É –¥—Ä—É–≥–∏—Ö —Ç–æ–∂–µ –µ—Å—Ç—å",
    "–ü–µ—Ä–µ–º–µ–Ω–∞ –¥–∞–Ω–∞ –Ω–µ –¥–ª—è —É—á–µ–±—ã, –∞ –¥–ª—è –æ—Ç–¥—ã—Ö–∞",
    "–°–æ–Ω –≤–∞–∂–Ω–µ–µ, —á–µ–º –¥–æ—É—á–∏–≤–∞–Ω–∏–µ –Ω–æ—á—å—é",
    "–†–∞–±–æ—Ç–∞ –≤ –∫–æ–º–∞–Ω–¥–µ —ç–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è –∏ —Å–∏–ª—ã"
]

# –°–ª—É—á–∞–π–Ω—ã–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ)
RANDOM_PREDICTIONS = [
    "–°–µ–≥–æ–¥–Ω—è —Ç—ã —É–∑–Ω–∞–µ—à—å —á—Ç–æ-—Ç–æ, —á—Ç–æ –∏–∑–º–µ–Ω–∏—Ç —Ç–≤–æ–π –≤–∑–≥–ª—è–¥ –Ω–∞ —É—á–µ–±—É",
    "–í —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è –∫ —Ç–µ–±–µ –ø—Ä–∏–¥–µ—Ç –æ–∑–∞—Ä–µ–Ω–∏–µ –ø–æ —Å–ª–æ–∂–Ω–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É",
    "–¢—ã –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ –ø–æ–ª—É—á–∏—à—å –ø–æ–º–æ—â—å –æ—Ç —Ç–æ–≥–æ, –æ—Ç –∫–æ–≥–æ –Ω–µ –æ–∂–∏–¥–∞–ª",
    "–°–ª—É—á–∞–π–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–º—É —Ä–∞–∑–≥–æ–≤–æ—Ä—É",
    "–¢—ã –Ω–∞–π–¥–µ—à—å —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä–∞—è –º—É—á–∏–ª–∞ —Ç–µ–±—è –Ω–µ–¥–µ–ª—é",
    "–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –ø—Ä–∏–Ω–µ—Å–µ—Ç –º–∞–ª–µ–Ω—å–∫—É—é, –Ω–æ –ø—Ä–∏—è—Ç–Ω—É—é –ø–æ–±–µ–¥—É",
    "–¢—ã –æ—Ç–∫—Ä–æ–µ—à—å –≤ —Å–µ–±–µ –Ω–æ–≤—ã–π —Ç–∞–ª–∞–Ω—Ç",
    "–£–¥–∞—á–∞ —É–ª—ã–±–Ω–µ—Ç—Å—è —Ç–µ–±–µ –≤ —Å–∞–º—ã–π –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç"
]

# ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–†–ï–î–°–ö–ê–ó–ê–¢–ï–õ–Ø ==========
def get_daily_prediction(user_id: int) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –¥–µ–Ω—å"""
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º user_id –∏ —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –¥–ª—è –ø—Å–µ–≤–¥–æ—Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
    seed = user_id + datetime.now().day + datetime.now().month * 100
    random.seed(seed)
    
    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    category = random.choice(list(PREDICTION_CATEGORIES.keys()))
    
    # –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    prediction = random.choice(PREDICTION_CATEGORIES[category])
    
    # –° –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 30% –¥–æ–±–∞–≤–ª—è–µ–º –º—É–¥—Ä—ã–π —Å–æ–≤–µ—Ç
    if random.random() < 0.3:
        tip = random.choice(STUDENT_TIPS)
        return f"üéì <b>–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ({category.title()}):</b>\n\n{prediction}\n\nüí° <b>–°–æ–≤–µ—Ç –¥–Ω—è:</b>\n{tip}"
    
    # –° –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 20% –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
    if random.random() < 0.2:
        extra_prediction = random.choice(RANDOM_PREDICTIONS)
        return f"üéì <b>–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ({category.title()}):</b>\n\n{prediction}\n\n‚ú® <b>–ë–æ–Ω—É—Å-–ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ:</b>\n{extra_prediction}"
    
    return f"üéì <b>–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ({category.title()}):</b>\n\n{prediction}"

def get_prediction_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π"""
    keyboard = [
        [InlineKeyboardButton("üéØ –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è", callback_data='get_prediction')],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π", callback_data='prediction_stats')],
        [InlineKeyboardButton("‚ùì –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç–µ–ª—å?", callback_data='how_predictor_works')],
        [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç—É–¥–µ–Ω—Ç–∞–º", callback_data='studentam')]
    ]
    return InlineKeyboardMarkup(keyboard)


def load_ratings():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥ –≥—Ä—É–ø–ø –∏–∑ JSON. –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —Ñ–∞–π–ª: config/ratings.json"""
    try:
        CONFIG_DIR.mkdir(parents=True, exist_ok=True)
        if RATINGS_FILE.exists():
            with open(RATINGS_FILE, "r", encoding="utf-8") as f:
                data = json.load(f)
                if data and "groups" in data:
                    return data
    except (json.JSONDecodeError, IOError, OSError) as e:
        logger.debug("load_ratings: %s", e)
    return {
        "specialty_code": "09.02.07",
        "specialty_name": "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ",
        "groups": [
            {"name": "–°–ò–ü-113/25", "place": 1, "score": 0},
            {"name": "–°–ò–ü-123/25", "place": 2, "score": 0},
            {"name": "–°–ò–ü-133/25", "place": 3, "score": 0},
            {"name": "–°–ò–ü-143/25", "place": 4, "score": 0},
        ],
        "updated": "",
    }


def load_weekly_poll():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–ø—Ä–æ—Å. –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —Ñ–∞–π–ª: config/weekly_poll.json"""
    try:
        if WEEKLY_POLL_FILE.exists():
            with open(WEEKLY_POLL_FILE, "r", encoding="utf-8") as f:
                return json.load(f)
    except (json.JSONDecodeError, IOError):
        pass
    return {
        "url": "https://forms.yandex.ru/u/68ba8dd7d04688778fbd630a",
        "description": "–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–ø—Ä–æ—Å –ö–°–¢",
        "updated": "",
    }


# ========== –°–û–ó–î–ê–ù–ò–ï –ö–õ–ê–í–ò–ê–¢–£–† (—Å—Ö–µ–º–∞ –ö–°–¢ ‚ö°Ô∏è) ==========
def get_main_menu_keyboard():
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ö–°–¢ ‚ö°Ô∏è ‚Äî Reply Keyboard"""
    keyboard = [
        [KeyboardButton("–ü–ï–î–ê–ì–û–ì–ê–ú"), KeyboardButton("–ê–ë–ò–¢–£–†–ò–ï–ù–¢–ê–ú")],
        [KeyboardButton("–°–¢–£–î–ï–ù–¢–ê–ú")],
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True, is_persistent=True)

def get_main_menu_inline():
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ‚Äî Inline (–¥–ª—è –∫–Ω–æ–ø–∫–∏ –ù–∞–∑–∞–¥)"""
    keyboard = [
        [InlineKeyboardButton("–ü–ï–î–ê–ì–û–ì–ê–ú", callback_data='pedagogam')],
        [InlineKeyboardButton("–ê–ë–ò–¢–£–†–ò–ï–ù–¢–ê–ú", callback_data='abiturientam')],
        [InlineKeyboardButton("–°–¢–£–î–ï–ù–¢–ê–ú", callback_data='studentam')],
    ]
    return InlineKeyboardMarkup(keyboard)

def get_pedagogam_keyboard():
    """–ü–ï–î–ê–ì–û–ì–ê–ú"""
    keyboard = [
        [InlineKeyboardButton("–û–ø—Ä–æ—Å—ã", callback_data='polls')],
        [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data='back_main')]
    ]
    return InlineKeyboardMarkup(keyboard)

def get_abiturientam_keyboard():
    """–ê–ë–ò–¢–£–†–ò–ï–ù–¢–ê–ú"""
    keyboard = [
        [InlineKeyboardButton("–ß–∞—Ç", callback_data='chat')],
        [InlineKeyboardButton("‚ùì –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã", callback_data='faq')],
        [InlineKeyboardButton("–î–Ω–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π", callback_data='open_doors')],
        [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data='back_main')]
    ]
    return InlineKeyboardMarkup(keyboard)

def get_studentam_keyboard():
    """–°–¢–£–î–ï–ù–¢–ê–ú ‚Äî –æ–ø—Ä–æ—Å—ã (–ø–æ –≥—Ä—É–ø–ø–µ), —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π, –∑–∞–∫–∞–∑ —Å–ø—Ä–∞–≤–æ–∫, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–µ–¥–æ–≤"""
    keyboard = [
        [InlineKeyboardButton("üìã –û–ø—Ä–æ—Å—ã", callback_data='student_polls')],
        [InlineKeyboardButton("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π", callback_data='semesters')],
        [InlineKeyboardButton("–ó–∞–∫–∞–∑ —Å–ø—Ä–∞–≤–æ–∫", callback_data='order_cert')],
        [InlineKeyboardButton("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–µ–¥–æ–≤", callback_data='lunch_schedule')],
        [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data='back_main')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_faq_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ FAQ ‚Äî –∫–Ω–æ–ø–∫–∏ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ (–Ω–∞–∂–∞—Ç–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç)"""
    buttons = []
    for i, (q, _) in enumerate(FAQ_ITEMS, 1):
        short_q = (q[:33] + "‚Ä¶") if len(q) > 33 else q
        buttons.append([InlineKeyboardButton(f"‚ùì {short_q}", callback_data=f'faq_{i}')])
    buttons.append([InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–∞–º", callback_data='abiturientam')])
    return InlineKeyboardMarkup(buttons)


def get_open_doors_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ ¬´–î–Ω–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π¬ª ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –¥–∞—Ç–∞–º–∏"""
    buttons = []
    for i, card in enumerate(OPEN_DOORS_CARDS):
        label = f"üìÖ {card['date']}"
        if card.get('title'):
            label += f" ‚Äî {card['title'][:25]}"
            if len(card['title']) > 25:
                label += "‚Ä¶"
        buttons.append([InlineKeyboardButton(label, callback_data=f'open_door_{i}')])
    buttons.append([InlineKeyboardButton("üåê –í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–∞ —Å–∞–π—Ç–µ", url="https://school.mos.ru/mcrpo/portal/dod/#dod-list")])
    buttons.append([InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–∞–º", callback_data='abiturientam')])
    return InlineKeyboardMarkup(buttons)


def get_polls_keyboard():
    """–ü–ï–î–ê–ì–û–ì–ê–ú ‚Äî –û–ø—Ä–æ—Å—ã: —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å"""
    keyboard = [
        [InlineKeyboardButton("üìù –°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å (–ø–æ —à–∞–±–ª–æ–Ω—É)", callback_data='poll_create')],
        [InlineKeyboardButton("üì• –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ä–æ—Å (—Å—Å—ã–ª–∫–∞/—Ñ–∞–π–ª)", callback_data='poll_import')],
        [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–µ–¥–∞–≥–æ–≥–∞–º", callback_data='pedagogam')]
    ]
    return InlineKeyboardMarkup(keyboard)

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ==========
def _clear_session_login(context: ContextTypes.DEFAULT_TYPE):
    """–°–±—Ä–æ—Å ¬´–≤–æ–π—Ç–∏ –≤ —ç—Ç—É —Å–µ—Å—Å–∏—é¬ª ‚Äî –ø–æ—Å–ª–µ /start –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –Ω—É–∂–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ –ø–æ –ø–∞—Ä–æ–ª—é."""
    context.user_data.pop("pedagog_logged_in", None)
    context.user_data.pop("student_logged_in", None)


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    _clear_session_login(context)
    user = update.effective_user
    welcome_text = (
        f"üëã –ü—Ä–∏–≤–µ—Ç, {user.first_name}!\n\n"
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ <b>–ö–°–¢ ‚ö°Ô∏è</b>!\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é:"
    )
    await update.message.reply_text(
        welcome_text,
        reply_markup=get_main_menu_keyboard(),
        parse_mode='HTML'
    )

async def menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /menu"""
    await update.message.reply_text(
        "üì± <b>–ö–°–¢ ‚ö°Ô∏è</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
        reply_markup=get_main_menu_keyboard(),
        parse_mode='HTML'
    )

async def predictor_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /predictor –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞"""
    user = update.effective_user
    predictor_text = (
        f"üîÆ <b>–ë–æ—Ç-–ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç–µ–ª—å –ö–°–¢</b>\n\n"
        f"–ü—Ä–∏–≤–µ—Ç, {user.first_name}! –Ø –∑–Ω–∞—é, —á—Ç–æ –∂–¥–µ—Ç —Ç–µ–±—è —Å–µ–≥–æ–¥–Ω—è –≤ –∫–æ–ª–ª–µ–¥–∂–µ!\n\n"
        f"–ú–æ–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞:\n"
        f"‚Ä¢ –¢–≤–æ–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–º ID\n"
        f"‚Ä¢ –¢–µ–∫—É—â–µ–π –¥–∞—Ç–µ\n"
        f"‚Ä¢ –°–µ–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–π –º—É–¥—Ä–æ—Å—Ç–∏\n\n"
        f"<i>–ü–æ–º–Ω–∏: –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è ‚Äî —ç—Ç–æ —à—É—Ç–∫–∞ –∏ —Å–ø–æ—Å–æ–± –ø–æ–¥–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ! üòâ</i>"
    )
    
    await update.message.reply_text(
        predictor_text,
        reply_markup=get_prediction_keyboard(),
        parse_mode='HTML'
    )


async def restart_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """/restart ‚Äî ¬´–º—è–≥–∫–∏–π¬ª –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –¥–∏–∞–ª–æ–≥–∞ —Å –±–æ—Ç–æ–º."""
    user = update.effective_user
    user_id = user.id if user else 0

    if BOT_OWNER_ID and user_id != BOT_OWNER_ID:
        await update.message.reply_text("‚õîÔ∏è –ö–æ–º–∞–Ω–¥–∞ /restart –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
        return

    # –°–æ–æ–±—â–∞–µ–º –æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
    await update.message.reply_text("üîÑ –ü–ï–†–ï–ó–ê–ì–†–£–ñ–ê–Æ –ë–û–¢–ê...")

    # ¬´–û—á–∏—Å—Ç–∫–∞¬ª: –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /restart, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∞ –≤ —á–∞—Ç–µ
    try:
        await update.message.delete()
    except Exception:
        # –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        pass

    _clear_session_login(context)
    name = user.first_name if user and user.first_name else "–¥—Ä—É–≥"
    welcome_text = (
        f"üëã –ü—Ä–∏–≤–µ—Ç, {name}!\n\n"
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ <b>–ö–°–¢ ‚ö°Ô∏è</b>!\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é:"
    )
    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text=welcome_text,
        reply_markup=get_main_menu_keyboard(),
        parse_mode="HTML",
    )

def get_reply_for_menu_button(text: str):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (—Ç–µ–∫—Å—Ç, –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞) –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é"""
    menus = {
        "–ü–ï–î–ê–ì–û–ì–ê–ú": ("<b>–ü–ï–î–ê–ì–û–ì–ê–ú</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:", get_pedagogam_keyboard()),
        "–ê–ë–ò–¢–£–†–ò–ï–ù–¢–ê–ú": ("<b>–ê–ë–ò–¢–£–†–ò–ï–ù–¢–ê–ú</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:", get_abiturientam_keyboard()),
        "–°–¢–£–î–ï–ù–¢–ê–ú": ("<b>–°–¢–£–î–ï–ù–¢–ê–ú</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:", get_studentam_keyboard()),
    }
    return menus.get(text)

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = (
        "<b>üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n\n"
        "/start ‚Äî –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞\n"
        "/restart ‚Äî –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞\n"
        "/menu ‚Äî –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
        "/help ‚Äî –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
        "/about ‚Äî –û –ø—Ä–æ–µ–∫—Ç–µ\n"
        "/announcements ‚Äî –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è\n"
        "/newsfeed ‚Äî –õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤\n\n"
        "<b>üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞:</b>\n"
        "–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º."
    )
    await update.message.reply_text(help_text, parse_mode='HTML')

async def about(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /about"""
    about_text = (
        "<b>ü§ñ –ö–°–¢ ‚ö°Ô∏è</b>\n\n"
        "–ë–æ—Ç –∫–æ–ª–ª–µ–¥–∂–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –¥–ª—è –ø–µ–¥–∞–≥–æ–≥–æ–≤, –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤ –∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤.\n\n"
        "üìö <b>–†–∞–∑–¥–µ–ª—ã:</b>\n"
        "‚Ä¢ –ü–ï–î–ê–ì–û–ì–ê–ú ‚Äî –æ–ø—Ä–æ—Å—ã (—Å–æ–∑–¥–∞–Ω–∏–µ/–∏–º–ø–æ—Ä—Ç)\n"
        "‚Ä¢ –ê–ë–ò–¢–£–†–ò–ï–ù–¢–ê–ú ‚Äî —á–∞—Ç, FAQ, –¥–Ω–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π\n"
        "‚Ä¢ –°–¢–£–î–ï–ù–¢–ê–ú ‚Äî –æ–ø—Ä–æ—Å—ã (–ø–æ –≤–∞—à–µ–π –≥—Ä—É–ø–ø–µ), —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π, –∑–∞–∫–∞–∑ —Å–ø—Ä–∞–≤–æ–∫, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–µ–¥–æ–≤\n\n"
        "üí° –ë–æ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è!"
    )
    await update.message.reply_text(about_text, parse_mode='HTML')

# ========== –ö–û–ú–ê–ù–î–ê: /announcements ==========
async def announcements_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∏–∑ –∫–∞–Ω–∞–ª–∞"""
    announcement_text = (
        f"üì¢ <b>–û–ë–™–Ø–í–õ–ï–ù–ò–Ø –ö–°–¢</b>\n\n"
        f"–í—Å–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤ –∫–∞–Ω–∞–ª–µ:\n"
        f"{ANNOUNCEMENTS_CHANNEL_USERNAME}\n\n"
        f"<i>–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º –∫–∞–Ω–∞–ª–µ.</i>"
    )
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üì¢ –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞–Ω–∞–ª –æ–±—ä—è–≤–ª–µ–Ω–∏–π", url=ANNOUNCEMENTS_CHANNEL_LINK)],
        [InlineKeyboardButton("‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_main')]
    ])
    
    await update.message.reply_text(
        announcement_text,
        reply_markup=keyboard,
        parse_mode='HTML'
    )

# ========== –ö–û–ú–ê–ù–î–ê: /newsfeed ==========
async def newsfeed_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–µ–Ω—Ç—É –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤"""
    newsfeed_text = (
        f"üì∞ <b>–ü–ï–†–°–û–ù–ê–õ–¨–ù–ê–Ø –õ–ï–ù–¢–ê –ù–û–í–û–°–¢–ï–ô</b>\n\n"
        f"–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª –¥–ª—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤ —Å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:\n\n"
        f"‚Ä¢ –í–∞–∂–Ω—ã–µ –¥–∞—Ç—ã –∏ —Å—Ä–æ–∫–∏\n"
        f"‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö –ø—Ä–∏–µ–º–∞\n"
        f"‚Ä¢ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ –¥–Ω–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π\n"
        f"‚Ä¢ –°–æ–≤–µ—Ç—ã –ø–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ\n"
        f"‚Ä¢ –û—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n\n"
        f"–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª:\n"
        f"{NEWS_FEED_CHANNEL_USERNAME}"
    )
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üì∞ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–æ–≤–æ—Å—Ç–∏", url=NEWS_FEED_CHANNEL_LINK)],
        [InlineKeyboardButton("‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_main')]
    ])
    
    await update.message.reply_text(
        newsfeed_text,
        reply_markup=keyboard,
        parse_mode='HTML'
    )

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö ==========
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    user_id = query.from_user.id
    
    if data == 'back_main':
        text = "üì± <b>–ö–°–¢ ‚ö°Ô∏è</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
        reply_markup = get_main_menu_inline()
    
    elif data == 'pedagogam':
        context.user_data.pop('state', None)
        context.user_data.pop('poll_title', None)
        context.user_data.pop('poll_question', None)
        context.user_data.pop('poll_options', None)
        if not database.is_pedagog_registered(user_id):
            text = (
                "<b>–ü–ï–î–ê–ì–û–ì–ê–ú</b>\n\n"
                "–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞–∑–¥–µ–ª—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.\n\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
            )
            reply_markup = InlineKeyboardMarkup([
                [InlineKeyboardButton("üîê –í–æ–π—Ç–∏", callback_data='pedagog_login')],
                [InlineKeyboardButton("üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", callback_data='pedagog_register')],
                [InlineKeyboardButton("‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_main')]
            ])
        elif not context.user_data.get("pedagog_logged_in"):
            text = (
                "<b>–ü–ï–î–ê–ì–û–ì–ê–ú</b>\n\n"
                "–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ —Å–≤–æ–∏–º –ø–∞—Ä–æ–ª–µ–º:"
            )
            reply_markup = InlineKeyboardMarkup([
                [InlineKeyboardButton("üîê –í–æ–π—Ç–∏", callback_data='pedagog_login')],
                [InlineKeyboardButton("‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_main')]
            ])
        else:
            text = "<b>–ü–ï–î–ê–ì–û–ì–ê–ú</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
            reply_markup = get_pedagogam_keyboard()
    
    elif data == 'abiturientam':
        text = "<b>–ê–ë–ò–¢–£–†–ò–ï–ù–¢–ê–ú</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
        reply_markup = get_abiturientam_keyboard()
    
    elif data == 'studentam':
        context.user_data.pop('state', None)
        context.user_data.pop('cert_fio', None)
        context.user_data.pop('cert_group', None)
        context.user_data.pop('poll_title', None)
        context.user_data.pop('poll_question', None)
        context.user_data.pop('poll_options', None)
        if not database.is_student_registered(user_id):
            text = (
                "<b>–°–¢–£–î–ï–ù–¢–ê–ú</b>\n\n"
                "–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å? –ù–∞–∂–º–∏—Ç–µ <b>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</b> ‚Äî —Å–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é —É—á—ë—Ç–Ω—É—é –∑–∞–ø–∏—Å—å (–§–ò–û, –≥—Ä—É–ø–ø–∞, –ø–∞—Ä–æ–ª—å).\n\n"
                "–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –ù–∞–∂–º–∏—Ç–µ <b>–í–æ–π—Ç–∏</b> –∏ –≤–≤–µ–¥–∏—Ç–µ –§–ò–û –∏ –ø–∞—Ä–æ–ª—å."
            )
            reply_markup = InlineKeyboardMarkup([
                [InlineKeyboardButton("üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", callback_data='student_register')],
                [InlineKeyboardButton("üîê –í–æ–π—Ç–∏", callback_data='student_login')],
                [InlineKeyboardButton("‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_main')]
            ])
        elif not context.user_data.get("student_logged_in"):
            text = (
                "<b>–°–¢–£–î–ï–ù–¢–ê–ú</b>\n\n"
                "–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ —Å–≤–æ–∏–º –ø–∞—Ä–æ–ª–µ–º:"
            )
            reply_markup = InlineKeyboardMarkup([
                [InlineKeyboardButton("üîê –í–æ–π—Ç–∏", callback_data='student_login')],
                [InlineKeyboardButton("‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_main')]
            ])
        else:
            text = "<b>–°–¢–£–î–ï–ù–¢–ê–ú</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
            reply_markup = get_studentam_keyboard()
    
    elif data == 'faq':
        text = "‚ùì <b>–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã</b> (–∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–∞–º)\n\n–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å ‚Äî –ø–æ–¥ –Ω–∏–º –ø–æ—è–≤–∏—Ç—Å—è –æ—Ç–≤–µ—Ç:"
        reply_markup = get_faq_keyboard()
    
    elif data.startswith('faq_'):
        try:
            idx = int(data.split('_')[1])
            if 1 <= idx <= len(FAQ_ITEMS):
                q, a = FAQ_ITEMS[idx - 1]
                text = f"<b>–í–æ–ø—Ä–æ—Å:</b> {q}\n\n<b>–û—Ç–≤–µ—Ç:</b>\n{a}"
                reply_markup = InlineKeyboardMarkup([
                    [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –≤–æ–ø—Ä–æ—Å–∞–º", callback_data='faq')]
                ])
            else:
                text = "‚ùì <b>–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å:"
                reply_markup = get_faq_keyboard()
        except (ValueError, IndexError):
            text = "‚ùì <b>–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å:"
            reply_markup = get_faq_keyboard()
    
    elif data == 'order_cert':
        context.user_data['state'] = 'cert_fio'
        context.user_data.pop('cert_fio', None)
        context.user_data.pop('cert_group', None)
        text = "üìÑ <b>–ó–∞–∫–∞–∑ —Å–ø—Ä–∞–≤–∫–∏</b>\n\n–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ <b>–§–ò–û</b> (–ø–æ–ª–Ω–æ—Å—Ç—å—é):"
        reply_markup = InlineKeyboardMarkup([
            [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='studentam')]
        ])
        await query.edit_message_text(text, reply_markup=reply_markup, parse_mode='HTML')
        return
    
    elif data == 'chat':
        # –ß–∞—Ç ‚Äî —Ç–æ–ª—å–∫–æ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ –ê–ë–ò–¢–£–†–ò–ï–ù–¢–ê–ú (–≤ –°–¢–£–î–ï–ù–¢–ê–ú –∫–Ω–æ–ø–∫–∏ ¬´–ß–∞—Ç¬ª –Ω–µ—Ç)
        text = (
            "üí¨ <b>–ß–∞—Ç –ö–°–¢</b>\n\n"
            "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –æ–±—â–µ–º—É —á–∞—Ç—É –∫–æ–ª–ª–µ–¥–∂–∞, —á—Ç–æ–±—ã –æ–±—â–∞—Ç—å—Å—è "
            "—Å –¥—Ä—É–≥–∏–º–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏ –∏ –ø–æ–ª—É—á–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é."
        )
        reply_markup = InlineKeyboardMarkup([
            [InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç –ö–°–¢ üí¨", url=CHAT_LINK)],
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–∞–º", callback_data='abiturientam')]
        ])
    
    elif data == 'announcements':
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–û–±—ä—è–≤–ª–µ–Ω–∏—è"
        announcement_text = (
            f"üì¢ <b>–û–§–ò–¶–ò–ê–õ–¨–ù–´–ï –û–ë–™–Ø–í–õ–ï–ù–ò–Ø</b>\n\n"
            f"–í—Å–µ –≤–∞–∂–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è, –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏, "
            f"–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ –Ω–æ–≤–æ—Å—Ç–∏ –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –∑–¥–µ—Å—å:\n\n"
            f"üëâ {ANNOUNCEMENTS_CHANNEL_USERNAME}\n\n"
            f"<i>–ö–∞–Ω–∞–ª –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è. "
            f"–ü—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã.</i>"
        )
        
        reply_markup = InlineKeyboardMarkup([
            [InlineKeyboardButton("üì¢ –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞–Ω–∞–ª –æ–±—ä—è–≤–ª–µ–Ω–∏–π", url=ANNOUNCEMENTS_CHANNEL_LINK)],
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç—É–¥–µ–Ω—Ç–∞–º", callback_data='studentam')]
        ])
        
        await query.edit_message_text(
            announcement_text,
            reply_markup=reply_markup,
            parse_mode='HTML'
        )
        return
    
    elif data == 'news_feed':
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ª–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π"
        newsfeed_text = (
            f"üì∞ <b>–ü–ï–†–°–û–ù–ê–õ–¨–ù–ê–Ø –õ–ï–ù–¢–ê –ù–û–í–û–°–¢–ï–ô –î–õ–Ø –ê–ë–ò–¢–£–†–ò–ï–ù–¢–û–í</b>\n\n"
            f"–ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥–µ—Ç–µ —Å–∞–º—É—é –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:\n\n"
            f"‚Ä¢ <b>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å–ø—ã—Ç–∞–Ω–∏–π</b>\n"
            f"‚Ä¢ <b>–°—Ä–æ–∫–∏ –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</b>\n"
            f"‚Ä¢ <b>–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö –ø—Ä–∏–µ–º–∞</b>\n"
            f"‚Ä¢ <b>–î–Ω–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π –æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω</b>\n"
            f"‚Ä¢ <b>–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã</b>\n"
            f"‚Ä¢ <b>–ü—Ä–æ—Ö–æ–¥–Ω—ã–µ –±–∞–ª–ª—ã –ø—Ä–æ—à–ª—ã—Ö –ª–µ—Ç</b>\n"
            f"‚Ä¢ <b>–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–µ–π</b>\n\n"
            f"<i>–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤–∞–∂–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏!</i>"
        )
        
        reply_markup = InlineKeyboardMarkup([
            [InlineKeyboardButton("üì∞ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–æ–≤–æ—Å—Ç–∏ –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤", url=NEWS_FEED_CHANNEL_LINK)],
            [InlineKeyboardButton("üì¢ –û–±—â–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ö–°–¢", callback_data='announcements')],
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–∞–º", callback_data='abiturientam')]
        ])
        
        await query.edit_message_text(
            newsfeed_text,
            reply_markup=reply_markup,
            parse_mode='HTML'
        )
        return
    
    elif data == 'lunch_schedule':
        # –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–µ–¥–æ–≤ –ø–æ –≥—Ä—É–ø–ø–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ (–¥–∞—Ç–∞ + –≤—Ä–µ–º—è –∏–∑ –ë–î)
        user_group = (database.get_student_info(user_id) or {}).get("group") or database.get_student_group(user_id)
        reply_markup = InlineKeyboardMarkup([
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç—É–¥–µ–Ω—Ç–∞–º", callback_data='studentam')]
        ])
        if not user_group:
            await query.edit_message_text(
                "üçΩÔ∏è <b>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–µ–¥–æ–≤</b>\n\n"
                "–ß—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ —Å–≤–æ–µ–π –≥—Ä—É–ø–ø–µ, —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª –°–¢–£–î–ï–ù–¢–ê–ú –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É (–∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≥—Ä—É–ø–ø—ã).",
                reply_markup=reply_markup,
                parse_mode='HTML'
            )
            return
        rows = database.get_lunch_schedule(user_group)
        if not rows:
            await query.edit_message_text(
                f"üçΩÔ∏è <b>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–µ–¥–æ–≤</b>\n\n"
                f"–ì—Ä—É–ø–ø–∞: <b>{user_group}</b>\n\n"
                "–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã. –û–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π.",
                reply_markup=reply_markup,
                parse_mode='HTML'
            )
            return
        lines = [f"üçΩÔ∏è <b>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–µ–¥–æ–≤</b>\n\n–ì—Ä—É–ø–ø–∞: <b>{user_group}</b>\n"]
        for r in rows:
            _id, _gr, sdate, st, et, note = r
            # sdate –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ-—Ä—É—Å—Å–∫–∏
            try:
                from datetime import datetime as dt
                d = dt.strptime(sdate, "%Y-%m-%d")
                date_display = d.strftime("%d.%m.%Y")
            except Exception:
                date_display = sdate
            line = f"üìÖ <b>{date_display}</b>  üïê {st} ‚Äì {et}"
            if note and note.strip():
                line += f"\n   <i>{note.strip()}</i>"
            lines.append(line)
        await query.edit_message_text(
            "\n".join(lines),
            reply_markup=reply_markup,
            parse_mode='HTML'
        )
        return
    
    elif data == 'polls':
        context.user_data.pop('state', None)
        rows = database.get_polls_list_pedagog()
        lines = ["<b>üìã –û–ü–†–û–°–´ –î–õ–Ø –ü–ï–î–ê–ì–û–ì–û–í</b>\n\n–°–æ–∑–¥–∞–π—Ç–µ –æ–ø—Ä–æ—Å –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ. –°–ø–∏—Å–æ–∫ –æ–ø—Ä–æ—Å–æ–≤:\n"]
        for r in rows[:20]:
            title = r[2] or "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"
            aud = "—Å—Ç—É–¥–µ–Ω—Ç—ã" if (r[5] or "").strip() == "student" else ("–ø–µ–¥–∞–≥–æ–≥–∏" if (r[5] or "").strip() == "pedagog" else "‚Äî")
            gr = f" ({r[6]})" if r[6] else ""
            lines.append(f"‚Ä¢ {title} [{aud}]{gr}")
        if not rows:
            lines.append("–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø—Ä–æ—Å–æ–≤.")
        await query.edit_message_text(
            "\n".join(lines),
            reply_markup=get_polls_keyboard(),
            parse_mode='HTML'
        )
        return
    
    elif data == 'student_polls':
        # –ì—Ä—É–ø–ø–∞ –∏–∑ —É—á—ë—Ç–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏–ª–∏ –∏–∑ –≤—ã–±–æ—Ä–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ –û–ø—Ä–æ—Å—ã (—Å–≤—è–∑—å —Å –æ–ø—Ä–æ—Å–∞–º–∏ –ø–µ–¥–∞–≥–æ–≥–∞ –ø–æ target_groups –≤ –ë–î)
        user_group = (database.get_student_info(user_id) or {}).get("group") or database.get_student_group(user_id)
        if user_group is None:
            keyboard = [[InlineKeyboardButton(g, callback_data=f'stgr_{i}')] for i, g in enumerate(STUDENT_GROUPS)]
            keyboard.append([InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç—É–¥–µ–Ω—Ç–∞–º", callback_data='studentam')])
            await query.edit_message_text(
                "üìã <b>–û–ø—Ä–æ—Å—ã –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É –≥—Ä—É–ø–ø—É:",
                reply_markup=InlineKeyboardMarkup(keyboard),
                parse_mode='HTML'
            )
            return
        rows = database.get_polls_list_student(user_group)
        lines = ["<b>üìã –û–ü–†–û–°–´ –î–õ–Ø –°–¢–£–î–ï–ù–¢–û–í</b>\n\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ä–æ—Å—ã:\n"]
        for r in rows[:20]:
            lines.append(f"‚Ä¢ {r[2] or '–û–ø—Ä–æ—Å'}")
        if not rows:
            lines.append("–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã.")
        await query.edit_message_text(
            "\n".join(lines),
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç—É–¥–µ–Ω—Ç–∞–º", callback_data='studentam')]]),
            parse_mode='HTML'
        )
        return
    
    elif data.startswith('stgr_'):
        try:
            idx = int(data.replace('stgr_', '', 1))
            if 0 <= idx < len(STUDENT_GROUPS):
                database.set_student_group(user_id, STUDENT_GROUPS[idx])
        except ValueError:
            pass
        rows = database.get_polls_list_student(database.get_student_group(user_id))
        lines = ["<b>üìã –û–ü–†–û–°–´ –î–õ–Ø –°–¢–£–î–ï–ù–¢–û–í</b>\n\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ä–æ—Å—ã:\n"]
        for r in rows[:20]:
            lines.append(f"‚Ä¢ {r[2] or '–û–ø—Ä–æ—Å'}")
        if not rows:
            lines.append("–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã.")
        await query.edit_message_text(
            "\n".join(lines),
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç—É–¥–µ–Ω—Ç–∞–º", callback_data='studentam')]]),
            parse_mode='HTML'
        )
        return
    
    elif data.startswith('streg_gr_'):
        # –í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞
        try:
            idx = int(data.replace('streg_gr_', '', 1))
            if 0 <= idx < len(STUDENT_GROUPS):
                context.user_data["student_group"] = STUDENT_GROUPS[idx]
                context.user_data["state"] = "student_register_password"
                await query.edit_message_text(
                    f"–ì—Ä—É–ø–ø–∞ –≤—ã–±—Ä–∞–Ω–∞: <b>{STUDENT_GROUPS[idx]}</b>\n\n–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ <b>–ø–∞—Ä–æ–ª—å</b> (–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞):",
                    parse_mode='HTML',
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='studentam')]
                    ])
                )
        except ValueError:
            pass
        return
    
    elif data == 'poll_create':
        context.user_data['state'] = 'poll_create_title'
        context.user_data.pop('poll_title', None)
        context.user_data.pop('poll_question', None)
        context.user_data.pop('poll_options', None)
        text = (
            "üìù <b>–°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–∞ (—à–∞–±–ª–æ–Ω)</b>\n\n"
            "–í–≤–µ–¥–∏—Ç–µ <b>–Ω–∞–∑–≤–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–∞</b>:"
        )
        reply_markup = InlineKeyboardMarkup([
            [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='polls')]
        ])
        await query.edit_message_text(text, reply_markup=reply_markup, parse_mode='HTML')
        return
    
    elif data == 'pedagog_login':
        context.user_data.pop("pedagog_fio", None)
        context.user_data.pop("pedagog_password", None)
        # –ö–∞–∫ —É —Å—Ç—É–¥–µ–Ω—Ç–∞: –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ–¥–∞–≥–æ–≥ –≤—ã–±–∏—Ä–∞–µ—Ç —É—á—ë—Ç–Ω—É—é –∑–∞–ø–∏—Å—å –∏–∑ —Å–ø–∏—Å–∫–∞, –∑–∞—Ç–µ–º –≤–≤–æ–¥–∏—Ç –ø–∞—Ä–æ–ª—å
        if database.is_pedagog_registered(user_id):
            fio = database.get_pedagog_fio(user_id) or "–ü–µ–¥–∞–≥–æ–≥"
            text = "üîê <b>–í—Ö–æ–¥ –¥–ª—è –ø–µ–¥–∞–≥–æ–≥–æ–≤</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—é —É—á—ë—Ç–Ω—É—é –∑–∞–ø–∏—Å—å:"
            reply_markup = InlineKeyboardMarkup([
                [InlineKeyboardButton(f"üë§ {fio}", callback_data='pedagog_confirm_account')],
                [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='pedagogam')]
            ])
            await query.edit_message_text(text, parse_mode='HTML', reply_markup=reply_markup)
        else:
            context.user_data["state"] = "pedagog_login_fio"
            await query.edit_message_text(
                "üîê <b>–í—Ö–æ–¥ –¥–ª—è –ø–µ–¥–∞–≥–æ–≥–æ–≤</b>\n\n–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ <b>–§–ò–û</b> (–ø–æ–ª–Ω–æ—Å—Ç—å—é):",
                parse_mode='HTML',
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='pedagogam')]
                ])
            )
        return
    
    elif data == 'pedagog_confirm_account':
        fio = database.get_pedagog_fio(user_id)
        if not fio:
            await query.edit_message_text(
                "<b>–ü–ï–î–ê–ì–û–ì–ê–ú</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
                reply_markup=get_pedagogam_keyboard(),
                parse_mode='HTML'
            )
            return
        context.user_data["pedagog_fio"] = fio
        context.user_data["state"] = "pedagog_login_password"
        await query.edit_message_text(
            f"üîê <b>–í—Ö–æ–¥</b>\n\n–í—ã: <b>{fio}</b>\n\n–í–≤–µ–¥–∏—Ç–µ –≤–∞—à <b>–ø–∞—Ä–æ–ª—å</b>:",
            parse_mode='HTML',
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='pedagogam')]
            ])
        )
        return
    
    elif data == 'pedagog_register':
        if not database.is_pedagog_registered(user_id):
            context.user_data["state"] = "pedagog_register_fio"
            context.user_data.pop("pedagog_fio", None)
            context.user_data.pop("pedagog_password", None)
            await query.edit_message_text(
                "üìù <b>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–µ–¥–∞–≥–æ–≥–∞</b>\n\n–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ <b>–§–ò–û</b> (–ø–æ–ª–Ω–æ—Å—Ç—å—é):",
                parse_mode='HTML',
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='pedagogam')]
                ])
            )
        else:
            await query.edit_message_text(
                "<b>–ü–ï–î–ê–ì–û–ì–ê–ú</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
                reply_markup=get_pedagogam_keyboard(),
                parse_mode='HTML'
            )
        return
    
    elif data == 'student_login':
        context.user_data.pop("student_fio", None)
        context.user_data.pop("student_password", None)
        if database.is_student_registered(user_id):
            info = database.get_student_info(user_id)
            if info:
                label = f"{info['fio']} ({info['group']})"
            else:
                label = "–°—Ç—É–¥–µ–Ω—Ç"
            text = "üîê <b>–í—Ö–æ–¥ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ —É—á—ë—Ç–Ω—É—é –∑–∞–ø–∏—Å—å:"
            reply_markup = InlineKeyboardMarkup([
                [InlineKeyboardButton(f"üë§ {label}", callback_data='student_confirm_account')],
                [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='studentam')]
            ])
            await query.edit_message_text(text, parse_mode='HTML', reply_markup=reply_markup)
        else:
            context.user_data["state"] = "student_login_fio"
            await query.edit_message_text(
                "üîê <b>–í—Ö–æ–¥ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</b>\n\n–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ <b>–§–ò–û</b> (–ø–æ–ª–Ω–æ—Å—Ç—å—é):",
                parse_mode='HTML',
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='studentam')]
                ])
            )
        return
    
    elif data == 'student_confirm_account':
        info = database.get_student_info(user_id)
        if not info:
            await query.edit_message_text(
                "<b>–°–¢–£–î–ï–ù–¢–ê–ú</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
                reply_markup=get_studentam_keyboard(),
                parse_mode='HTML'
            )
            return
        context.user_data["student_fio"] = info["fio"]
        context.user_data["state"] = "student_login_password"
        await query.edit_message_text(
            f"üîê <b>–í—Ö–æ–¥</b>\n\n–í—ã: <b>{info['fio']}</b>, –≥—Ä—É–ø–ø–∞ {info['group']}\n\n–í–≤–µ–¥–∏—Ç–µ –≤–∞—à <b>–ø–∞—Ä–æ–ª—å</b>:",
            parse_mode='HTML',
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='studentam')]
            ])
        )
        return
    
    elif data == 'student_register':
        if not database.is_student_registered(user_id):
            context.user_data["state"] = "student_register_fio"
            context.user_data.pop("student_fio", None)
            context.user_data.pop("student_group", None)
            context.user_data.pop("student_password", None)
            await query.edit_message_text(
                "üìù <b>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞</b>\n\n–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ <b>–§–ò–û</b> (–ø–æ–ª–Ω–æ—Å—Ç—å—é):",
                parse_mode='HTML',
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='studentam')]
                ])
            )
        else:
            await query.edit_message_text(
                "<b>–°–¢–£–î–ï–ù–¢–ê–ú</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
                reply_markup=get_studentam_keyboard(),
                parse_mode='HTML'
            )
        return
    
    elif data == 'poll_import':
        context.user_data['state'] = 'poll_import'
        text = (
            "üì• <b>–ò–º–ø–æ—Ä—Ç –æ–ø—Ä–æ—Å–∞</b>\n\n"
            "–û—Ç–ø—Ä–∞–≤—å—Ç–µ <b>—Å—Å—ã–ª–∫—É</b> –Ω–∞ –æ–ø—Ä–æ—Å (–Ø–Ω–¥–µ–∫—Å.–§–æ—Ä–º—ã, Google Forms –∏ —Ç.–ø.) "
            "–∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ <b>—Ñ–∞–π–ª</b> —Å –æ–ø—Ä–æ—Å–æ–º. –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î."
        )
        reply_markup = InlineKeyboardMarkup([
            [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='polls')]
        ])
        await query.edit_message_text(text, reply_markup=reply_markup, parse_mode='HTML')
        return
    
    elif data == 'poll_target_pedagog':
        title = context.user_data.get("poll_title", "‚Äî")
        question = context.user_data.get("poll_question", "‚Äî")
        options = context.user_data.get("poll_options", "‚Äî")
        uid = query.from_user.id if query.from_user else 0
        try:
            database.save_poll(uid, "created", title, question, options, None, "pedagog", "")
        except Exception as e:
            logger.exception("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–ø—Ä–æ—Å–∞: %s", e)
        context.user_data.pop("state", None)
        context.user_data.pop("poll_title", None)
        context.user_data.pop("poll_question", None)
        context.user_data.pop("poll_options", None)
        rows = database.get_polls_list_pedagog()
        lines = ["<b>üìã –û–ü–†–û–°–´ –î–õ–Ø –ü–ï–î–ê–ì–û–ì–û–í</b>\n\n‚úÖ –û–ø—Ä–æ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω.\n\n–°–ø–∏—Å–æ–∫ –æ–ø—Ä–æ—Å–æ–≤:\n"]
        for r in rows[:20]:
            title_r = r[2] or "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"
            aud = "—Å—Ç—É–¥–µ–Ω—Ç—ã" if (r[5] or "").strip() == "student" else ("–ø–µ–¥–∞–≥–æ–≥–∏" if (r[5] or "").strip() == "pedagog" else "‚Äî")
            gr = f" ({r[6]})" if r[6] else ""
            lines.append(f"‚Ä¢ {title_r} [{aud}]{gr}")
        await query.edit_message_text("\n".join(lines), reply_markup=get_polls_keyboard(), parse_mode='HTML')
        return
    
    elif data == 'poll_target_student':
        context.user_data["poll_target_groups"] = []
        keyboard = [[InlineKeyboardButton(g, callback_data=f'poll_gr_{i}')] for i, g in enumerate(STUDENT_GROUPS)]
        keyboard.append([InlineKeyboardButton("‚úÖ –í—Å–µ –≥—Ä—É–ø–ø—ã", callback_data='poll_gr_all')])
        keyboard.append([InlineKeyboardButton("‚úÖ –ì–æ—Ç–æ–≤–æ", callback_data='poll_gr_done')])
        await query.edit_message_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ <b>–≥—Ä—É–ø–ø—ã</b> (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ), –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ ¬´–ì–æ—Ç–æ–≤–æ¬ª:",
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='HTML'
        )
        return
    
    elif data.startswith('poll_gr_'):
        sel = context.user_data.get("poll_target_groups") or []
        if data == 'poll_gr_all':
            context.user_data["poll_target_groups"] = list(STUDENT_GROUPS)
            sel = list(STUDENT_GROUPS)
        elif data == 'poll_gr_done':
            title = context.user_data.get("poll_title", "‚Äî")
            question = context.user_data.get("poll_question", "‚Äî")
            options = context.user_data.get("poll_options", "‚Äî")
            uid = query.from_user.id if query.from_user else 0
            tg = ",".join(context.user_data.get("poll_target_groups") or [])
            try:
                database.save_poll(uid, "created", title, question, options, None, "student", tg)
            except Exception as e:
                logger.exception("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–ø—Ä–æ—Å–∞: %s", e)
            for chat_id in database.get_student_user_ids_to_notify(tg):
                try:
                    await context.bot.send_message(
                        chat_id=chat_id,
                        text=f"üìã <b>–ù–æ–≤—ã–π –æ–ø—Ä–æ—Å –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</b>\n\n¬´{title}¬ª\n\n–ü—Ä–æ–π—Ç–∏ –æ–ø—Ä–æ—Å: —Ä–∞–∑–¥–µ–ª –°–¢–£–î–ï–ù–¢–ê–ú ‚Üí –û–ø—Ä–æ—Å—ã.",
                        parse_mode='HTML'
                    )
                except Exception as e:
                    logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ %s: %s", chat_id, e)
            context.user_data.pop("state", None)
            context.user_data.pop("poll_title", None)
            context.user_data.pop("poll_question", None)
            context.user_data.pop("poll_options", None)
            context.user_data.pop("poll_target_groups", None)
            rows = database.get_polls_list_pedagog()
            lines = ["<b>üìã –û–ü–†–û–°–´ –î–õ–Ø –ü–ï–î–ê–ì–û–ì–û–í</b>\n\n‚úÖ –û–ø—Ä–æ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –°—Ç—É–¥–µ–Ω—Ç–∞–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.\n\n–°–ø–∏—Å–æ–∫ –æ–ø—Ä–æ—Å–æ–≤:\n"]
            for r in rows[:20]:
                title_r = r[2] or "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"
                aud = "—Å—Ç—É–¥–µ–Ω—Ç—ã" if (r[5] or "").strip() == "student" else ("–ø–µ–¥–∞–≥–æ–≥–∏" if (r[5] or "").strip() == "pedagog" else "‚Äî")
                gr = f" ({r[6]})" if r[6] else ""
                lines.append(f"‚Ä¢ {title_r} [{aud}]{gr}")
            await query.edit_message_text("\n".join(lines), reply_markup=get_polls_keyboard(), parse_mode='HTML')
            return
        else:
            try:
                idx = int(data.replace("poll_gr_", "", 1))
                if 0 <= idx < len(STUDENT_GROUPS):
                    g = STUDENT_GROUPS[idx]
                    if g in sel:
                        sel = [x for x in sel if x != g]
                    else:
                        sel = sel + [g]
                    context.user_data["poll_target_groups"] = sel
            except ValueError:
                pass
        sel = context.user_data.get("poll_target_groups") or []
        keyboard = [[InlineKeyboardButton(g, callback_data=f'poll_gr_{i}')] for i, g in enumerate(STUDENT_GROUPS)]
        keyboard.append([InlineKeyboardButton("‚úÖ –í—Å–µ –≥—Ä—É–ø–ø—ã", callback_data='poll_gr_all')])
        keyboard.append([InlineKeyboardButton("‚úÖ –ì–æ—Ç–æ–≤–æ", callback_data='poll_gr_done')])
        chosen = ", ".join(sel) if sel else "‚Äî"
        await query.edit_message_text(
            f"–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—ã (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ), –∑–∞—Ç–µ–º ¬´–ì–æ—Ç–æ–≤–æ¬ª. –í—ã–±—Ä–∞–Ω–æ: {chosen}",
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='HTML'
        )
        return
    
    elif data == 'open_doors':
        context.user_data.pop("state", None)
        context.user_data.pop("open_door_event_index", None)
        # –ê–ë–ò–¢–£–†–ò–ï–ù–¢–ê–ú ‚Äî –î–Ω–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π: —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–æ—á–µ–∫
        open_doors_text = (
            "<b>üö™ –î–ù–ò –û–¢–ö–†–´–¢–´–• –î–í–ï–†–ï–ô</b>\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –¥–∞—Ç–æ–π –∏ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏.\n\n"
            "<b>–ß—Ç–æ –≤–∞—Å –∂–¥—ë—Ç:</b>\n"
            "‚Ä¢ –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –∫–æ–ª–ª–µ–¥–∂–µ–º –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—è–º–∏\n"
            "‚Ä¢ –≠–∫—Å–∫—É—Ä—Å–∏–∏ –ø–æ –∞—É–¥–∏—Ç–æ—Ä–∏—è–º –∏ –º–∞—Å—Ç–µ—Ä—Å–∫–∏–º\n"
            "‚Ä¢ –í—Å—Ç—Ä–µ—á–∞ —Å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏\n"
            "‚Ä¢ –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –∏ —É—á—ë–±–µ"
        )
        await query.edit_message_text(
            open_doors_text,
            reply_markup=get_open_doors_keyboard(),
            parse_mode='HTML'
        )
        return

    elif data.startswith('open_door_') and not data.startswith('open_door_signup_'):
        # –ü–æ–∫–∞–∑–∞—Ç—å –æ–¥–Ω—É –∫–∞—Ä—Ç–æ—á–∫—É (–¥–∞—Ç–∞ + –∫–∞—Ä—Ç–∏–Ω–∫–∞ + –æ–ø–∏—Å–∞–Ω–∏–µ) –∏ –∫–Ω–æ–ø–∫—É –∑–∞–ø–∏—Å–∏
        try:
            idx = int(data.split('_')[2])
        except (IndexError, ValueError):
            idx = 0
        if idx < 0 or idx >= len(OPEN_DOORS_CARDS):
            await query.answer("–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.", show_alert=True)
            return
        card = OPEN_DOORS_CARDS[idx]
        date = card.get("date", "")
        title = card.get("title", "–î–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π")
        description = card.get("description", "")
        caption = f"<b>üìÖ {date}</b>\n\n<b>{title}</b>\n\n{description}"
        buttons = []
        if database.is_registered_open_doors(user_id, idx):
            buttons.append([InlineKeyboardButton("‚úÖ –í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ", callback_data='open_door_noop')])
        else:
            buttons.append([InlineKeyboardButton("üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ", callback_data=f'open_door_signup_{idx}')])
        buttons.append([InlineKeyboardButton("‚óÄÔ∏è –ö —Å–ø–∏—Å–∫—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π", callback_data='open_doors')])
        reply_markup = InlineKeyboardMarkup(buttons)
        image_url = card.get("image_url")
        image_path = card.get("image_path")  # –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä "open_doors/1.jpg"
        photo = None
        if image_url and (str(image_url).startswith("http://") or str(image_url).startswith("https://")):
            photo = image_url
        elif image_path or (image_url and not (str(image_url).startswith("http"))):
            path = BOT_DIR / (image_path or image_url)
            if path.exists():
                photo = open(path, "rb")
        if photo:
            await context.bot.send_photo(
                chat_id=query.message.chat_id,
                photo=photo,
                caption=caption,
                parse_mode="HTML",
                reply_markup=reply_markup,
            )
            if hasattr(photo, "close"):
                photo.close()
        else:
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text=caption,
                parse_mode="HTML",
                reply_markup=reply_markup,
            )
        await query.answer()
        return

    elif data == 'open_door_noop':
        await query.answer("–í—ã —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ.", show_alert=False)
        return

    elif data.startswith('open_door_signup_'):
        # –ó–∞–ø–∏—Å—å –Ω–∞ –¥–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π: –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∏ –ø—Ä–æ—Å–∏–º –§–ò–û –∏ –∫–æ–Ω—Ç–∞–∫—Ç
        try:
            idx = int(data.split('_')[3])
        except (IndexError, ValueError):
            idx = 0
        if idx < 0 or idx >= len(OPEN_DOORS_CARDS):
            await query.answer("–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.", show_alert=True)
            return
        if database.is_registered_open_doors(user_id, idx):
            await query.answer("–í—ã —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ.", show_alert=True)
            return
        context.user_data["state"] = "open_door_signup"
        context.user_data["open_door_event_index"] = idx
        card = OPEN_DOORS_CARDS[idx]
        event_name = f"{card.get('date', '')} ‚Äî {card.get('title', '')}"
        await query.edit_message_text(
            f"üìù <b>–ó–∞–ø–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</b>\n\n"
            f"<b>{event_name}</b>\n\n"
            "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ <b>–§–ò–û</b> –∏ <b>–∫–æ–Ω—Ç–∞–∫—Ç</b> (—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email) –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: <i>–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á, +7 999 123-45-67</i>",
            parse_mode='HTML',
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='open_doors')]
            ])
        )
        await query.answer()
        return
    
    elif data == 'semesters':
        text = (
            "üìÖ <b>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π</b>\n\n"
            "–ê–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —ç–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ –∫–æ–ª–ª–µ–¥–∂–∞ –∏ –≤ –æ–±—ä—è–≤–ª–µ–Ω–∏—è—Ö. "
            "–£—Ç–æ—á–Ω—è–π—Ç–µ –¥–∞—Ç—ã —É –∫—É—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ –≤ —É—á–µ–±–Ω–æ–π —á–∞—Å—Ç–∏."
        )
        reply_markup = InlineKeyboardMarkup([
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç—É–¥–µ–Ω—Ç–∞–º", callback_data='studentam')]
        ])
    
    else:
        # –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤ ‚Äî –∑–∞–≥–ª—É—à–∫–∞
        labels = {
            'polls': '–û–ø—Ä–æ—Å—ã',
            'faq': '–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã',
            'semesters': '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π',
        }
        label = labels.get(data, data.replace('_', ' ').title())
        back_data = 'back_main'
        if data in ['semesters', 'lunch_schedule', 'order_cert']:
            back_data = 'studentam'
        elif data in ['polls', 'poll_create', 'poll_import']:
            back_data = 'pedagogam'
        elif data in ['faq', 'open_doors']:
            back_data = 'abiturientam'
        
        text = f"<b>‚öôÔ∏è –†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</b>\n\n{label}\n\n–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª!"
        reply_markup = InlineKeyboardMarkup([
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data=back_data)]
        ])
    
    await query.edit_message_text(text, reply_markup=reply_markup, parse_mode='HTML')

# ========== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
async def post_init(application: Application):
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∏ –∫–æ–º–∞–Ω–¥ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ (–°—Ç–∞—Ä—Ç –≤–∏–¥–µ–Ω –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –±–æ—Ç–∞)"""
    await application.bot.set_chat_menu_button(menu_button=MenuButtonCommands())
    await application.bot.set_my_commands([
        BotCommand("start", "–°—Ç–∞—Ä—Ç"),
        BotCommand("menu", "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"),
        BotCommand("help", "–°–ø—Ä–∞–≤–∫–∞"),
    ])
    print("–í—Å—ë –≥–æ—Ç–æ–≤–æ")

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –Ω–∞–∂–∞—Ç–∏–π –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é"""
    text = (update.message.text or "").strip()
    user_id = update.effective_user.id if update.effective_user else 0
    state = context.user_data.get("state")
    
    # –ö–Ω–æ–ø–∫–∞/—Ç–µ–∫—Å—Ç ¬´–°—Ç–∞—Ä—Ç¬ª ‚Äî –∫–∞–∫ /start: —Å–±—Ä–æ—Å —Å–µ—Å—Å–∏–∏ –∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–Ω—É–∂–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥)
    if text and text.lower() == "—Å—Ç–∞—Ä—Ç":
        _clear_session_login(context)
        user = update.effective_user
        name = user.first_name if user and user.first_name else "–¥—Ä—É–≥"
        await update.message.reply_text(
            f"üëã –ü—Ä–∏–≤–µ—Ç, {name}!\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ <b>–ö–°–¢ ‚ö°Ô∏è</b>!\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é:",
            reply_markup=get_main_menu_keyboard(),
            parse_mode='HTML'
        )
        return
    
    # --- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–µ–¥–∞–≥–æ–≥–∞: –§–ò–û -> –ø–∞—Ä–æ–ª—å ---
    if state == "pedagog_register_fio":
        context.user_data["pedagog_fio"] = text or ""
        context.user_data["state"] = "pedagog_register_password"
        await update.message.reply_text(
            "–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ <b>–ø–∞—Ä–æ–ª—å</b> (–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞):",
            parse_mode='HTML',
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='pedagogam')]
            ])
        )
        return
    if state == "pedagog_register_password":
        password = text or ""
        if len(password) < 4:
            await update.message.reply_text("‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑:")
            return
        fio = context.user_data.get("pedagog_fio", "")
        database.register_pedagog(user_id, fio, password)
        context.user_data["pedagog_logged_in"] = True
        context.user_data.pop("state", None)
        context.user_data.pop("pedagog_fio", None)
        context.user_data.pop("pedagog_password", None)
        await update.message.reply_text(
            f"‚úÖ <b>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</b>\n\n–§–ò–û: {fio}\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
            reply_markup=get_pedagogam_keyboard(),
            parse_mode='HTML'
        )
        return
    
    # --- –í—Ö–æ–¥ –ø–µ–¥–∞–≥–æ–≥–∞: –§–ò–û -> –ø–∞—Ä–æ–ª—å ---
    if state == "pedagog_login_fio":
        context.user_data["pedagog_fio"] = text or ""
        context.user_data["state"] = "pedagog_login_password"
        await update.message.reply_text(
            "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à <b>–ø–∞—Ä–æ–ª—å</b>:",
            parse_mode='HTML',
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='pedagogam')]
            ])
        )
        return
    if state == "pedagog_login_password":
        password = (text or "").strip()
        fio = context.user_data.get("pedagog_fio", "")
        # –í—Ö–æ–¥ –ø–æ —Å–≤–æ–µ–π —É—á—ë—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ (–≤—ã–±—Ä–∞–ª –∏–∑ —Å–ø–∏—Å–∫–∞) ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø–∞—Ä–æ–ª—å –ø–æ user_id
        if database.is_pedagog_registered(user_id):
            success = database.login_pedagog_by_user_id(user_id, password)
            db_user_id = user_id
        else:
            success, db_user_id = database.login_pedagog(fio, password)
        if success:
            if db_user_id != user_id:
                database.update_pedagog_user_id(db_user_id, user_id)
            context.user_data["pedagog_logged_in"] = True
            context.user_data.pop("state", None)
            context.user_data.pop("pedagog_fio", None)
            context.user_data.pop("pedagog_password", None)
            fio_display = fio or database.get_pedagog_fio(user_id)
            await update.message.reply_text(
                f"‚úÖ <b>–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!</b>\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {fio_display}!\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
                reply_markup=get_pedagogam_keyboard(),
                parse_mode='HTML'
            )
        else:
            is_reg = database.is_pedagog_registered(user_id)
            buttons = [
                [InlineKeyboardButton("üîê –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞", callback_data='pedagog_login')],
                [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data='pedagogam')]
            ]
            if not is_reg:
                buttons.insert(1, [InlineKeyboardButton("üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", callback_data='pedagog_register')])
            await update.message.reply_text(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑." + ("" if is_reg else " –ò–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å."),
                reply_markup=InlineKeyboardMarkup(buttons)
            )
        return
    
    # --- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞: –§–ò–û -> –≥—Ä—É–ø–ø–∞ -> –ø–∞—Ä–æ–ª—å ---
    if state == "student_register_fio":
        context.user_data["student_fio"] = text or ""
        context.user_data["state"] = "student_register_group"
        keyboard = [[InlineKeyboardButton(g, callback_data=f'streg_gr_{i}')] for i, g in enumerate(STUDENT_GROUPS)]
        keyboard.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='studentam')])
        await update.message.reply_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É <b>–≥—Ä—É–ø–ø—É</b> –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –µ—ë –Ω–∞–∑–≤–∞–Ω–∏–µ:",
            parse_mode='HTML',
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return
    if state == "student_register_group":
        # –ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –≤—ã–±—Ä–∞–Ω–∞ –∏–∑ —Å–ø–∏—Å–∫–∞, –æ–Ω–∞ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ user_data
        if "student_group" not in context.user_data:
            context.user_data["student_group"] = text or ""
        context.user_data["state"] = "student_register_password"
        await update.message.reply_text(
            "–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ <b>–ø–∞—Ä–æ–ª—å</b> (–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞):",
            parse_mode='HTML',
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='studentam')]
            ])
        )
        return
    if state == "student_register_password":
        password = text or ""
        if len(password) < 4:
            await update.message.reply_text("‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑:")
            return
        fio = context.user_data.get("student_fio", "")
        group = context.user_data.get("student_group", "")
        database.register_student(user_id, fio, group, password)
        context.user_data["student_logged_in"] = True
        context.user_data.pop("state", None)
        context.user_data.pop("student_fio", None)
        context.user_data.pop("student_group", None)
        context.user_data.pop("student_password", None)
        await update.message.reply_text(
            f"‚úÖ <b>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</b>\n\n–§–ò–û: {fio}\n–ì—Ä—É–ø–ø–∞: {group}\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
            reply_markup=get_studentam_keyboard(),
            parse_mode='HTML'
        )
        return
    
    # --- –í—Ö–æ–¥ —Å—Ç—É–¥–µ–Ω—Ç–∞: –§–ò–û -> –ø–∞—Ä–æ–ª—å ---
    if state == "student_login_fio":
        context.user_data["student_fio"] = text or ""
        context.user_data["state"] = "student_login_password"
        await update.message.reply_text(
            "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à <b>–ø–∞—Ä–æ–ª—å</b>:",
            parse_mode='HTML',
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='studentam')]
            ])
        )
        return
    if state == "student_login_password":
        password = (text or "").strip()
        fio = context.user_data.get("student_fio", "")
        # –í—Ö–æ–¥ –ø–æ —Å–≤–æ–µ–π —É—á—ë—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ (–≤—ã–±—Ä–∞–ª –∏–∑ —Å–ø–∏—Å–∫–∞) ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø–∞—Ä–æ–ª—å –ø–æ user_id
        if database.is_student_registered(user_id):
            success = database.login_student_by_user_id(user_id, password)
            db_user_id = user_id
        else:
            success, db_user_id = database.login_student(fio, password)
        if success:
            if db_user_id != user_id:
                database.update_student_user_id(db_user_id, user_id)
            context.user_data["student_logged_in"] = True
            student_info = database.get_student_info(user_id)
            context.user_data.pop("state", None)
            context.user_data.pop("student_fio", None)
            context.user_data.pop("student_password", None)
            if student_info:
                info_text = f"‚úÖ <b>–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!</b>\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {student_info['fio']}!\n–ì—Ä—É–ø–ø–∞: {student_info['group']}\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
            else:
                info_text = f"‚úÖ <b>–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!</b>\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {fio}!\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
            await update.message.reply_text(
                info_text,
                reply_markup=get_studentam_keyboard(),
                parse_mode='HTML'
            )
        else:
            is_reg = database.is_student_registered(user_id)
            buttons = [
                [InlineKeyboardButton("üîê –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞", callback_data='student_login')],
                [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data='studentam')]
            ]
            if not is_reg:
                buttons.insert(1, [InlineKeyboardButton("üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", callback_data='student_register')])
            await update.message.reply_text(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑." + ("" if is_reg else " –ò–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å."),
                reply_markup=InlineKeyboardMarkup(buttons)
            )
        return
    
    # --- –ó–∞–∫–∞–∑ —Å–ø—Ä–∞–≤–∫–∏: –§–ò–û -> –≥—Ä—É–ø–ø–∞ -> —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î ---
    if state == "cert_fio":
        context.user_data["cert_fio"] = text or "‚Äî"
        context.user_data["state"] = "cert_group"
        await update.message.reply_text("–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ <b>–Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</b> (–Ω–∞–ø—Ä–∏–º–µ—Ä, –°–ò–ü-113/25):", parse_mode="HTML")
        return
    if state == "cert_group":
        context.user_data["cert_group"] = text or "‚Äî"
        fio = context.user_data.get("cert_fio", "‚Äî")
        group_name = context.user_data.get("cert_group", "‚Äî")
        try:
            database.save_certificate_order(user_id, fio, group_name)
        except Exception as e:
            logger.exception("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ —Å–ø—Ä–∞–≤–∫–∏: %s", e)
        context.user_data.pop("state", None)
        context.user_data.pop("cert_fio", None)
        context.user_data.pop("cert_group", None)
        await update.message.reply_text(
            f"‚úÖ <b>–ó–∞—è–≤–∫–∞ –Ω–∞ —Å–ø—Ä–∞–≤–∫—É –ø—Ä–∏–Ω—è—Ç–∞.</b>\n\n–§–ò–û: {fio}\n–ì—Ä—É–ø–ø–∞: {group_name}\n\n–û–∂–∏–¥–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏.",
            parse_mode="HTML",
            reply_markup=get_main_menu_keyboard()
        )
        return
    
    # --- –ó–∞–ø–∏—Å—å –Ω–∞ –¥–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π: –§–ò–û –∏ –∫–æ–Ω—Ç–∞–∫—Ç -> –ë–î ---
    if state == "open_door_signup":
        event_index = context.user_data.get("open_door_event_index", 0)
        raw = (text or "").strip()
        if not raw:
            await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –§–ò–û –∏ –∫–æ–Ω—Ç–∞–∫—Ç (—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email), –Ω–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω, +7 999 123-45-67")
            return
        parts = [p.strip() for p in raw.split(",", 1)]
        fio = parts[0] if parts else raw
        contact = parts[1] if len(parts) > 1 else ""
        try:
            database.save_open_doors_registration(user_id, event_index, fio, contact)
        except Exception as e:
            logger.exception("–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –Ω–∞ –¥–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π: %s", e)
            await update.message.reply_text("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.", reply_markup=get_main_menu_keyboard())
            context.user_data.pop("state", None)
            context.user_data.pop("open_door_event_index", None)
            return
        context.user_data.pop("state", None)
        context.user_data.pop("open_door_event_index", None)
        card = OPEN_DOORS_CARDS[event_index] if event_index < len(OPEN_DOORS_CARDS) else {}
        event_name = f"{card.get('date', '')} ‚Äî {card.get('title', '')}"
        await update.message.reply_text(
            f"‚úÖ <b>–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ!</b>\n\n"
            f"<b>{event_name}</b>\n\n"
            f"–§–ò–û: {fio}\n" + (f"–ö–æ–Ω—Ç–∞–∫—Ç: {contact}\n" if contact else "") + "\n–ñ–¥—ë–º –≤–∞—Å! –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –∫–æ–Ω—Ç–∞–∫—Ç—É.",
            parse_mode="HTML",
            reply_markup=get_main_menu_keyboard()
        )
        return
    
    # --- –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–∞ (—à–∞–±–ª–æ–Ω): –Ω–∞–∑–≤–∞–Ω–∏–µ -> –≤–æ–ø—Ä–æ—Å -> –≤–∞—Ä–∏–∞–Ω—Ç—ã -> –ë–î ---
    if state == "poll_create_title":
        context.user_data["poll_title"] = text or "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"
        context.user_data["state"] = "poll_create_question"
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ <b>–≤–æ–ø—Ä–æ—Å –æ–ø—Ä–æ—Å–∞</b>:", parse_mode="HTML")
        return
    if state == "poll_create_question":
        context.user_data["poll_question"] = text or "‚Äî"
        context.user_data["state"] = "poll_create_options"
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ <b>–≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</b> (–Ω–∞–ø—Ä–∏–º–µ—Ä: –î–∞, –ù–µ—Ç, –ù–µ –∑–Ω–∞—é):", parse_mode="HTML")
        return
    if state == "poll_create_options":
        context.user_data["poll_options"] = text or "‚Äî"
        context.user_data["state"] = "poll_create_target"
        kb = InlineKeyboardMarkup([
            [InlineKeyboardButton("–î–ª—è –ø–µ–¥–∞–≥–æ–≥–æ–≤", callback_data='poll_target_pedagog')],
            [InlineKeyboardButton("–î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤", callback_data='poll_target_student')],
        ])
        await update.message.reply_text("–î–ª—è <b>–∫–æ–≥–æ</b> —Å–æ–∑–¥–∞—ë–º –æ–ø—Ä–æ—Å?", reply_markup=kb, parse_mode="HTML")
        return
    
    # --- –ò–º–ø–æ—Ä—Ç –æ–ø—Ä–æ—Å–∞: —Å—Å—ã–ª–∫–∞ –∏–ª–∏ —Ñ–∞–π–ª -> –ë–î ---
    if state == "poll_import":
        link_or_file = None
        if text and ("http://" in text or "https://" in text):
            link_or_file = text
        if update.message.document:
            link_or_file = f"file_id:{update.message.document.file_id}"
        if link_or_file:
            try:
                database.save_poll(user_id, "imported", None, None, None, link_or_file, None, None)
                await update.message.reply_text("‚úÖ –û–ø—Ä–æ—Å (—Å—Å—ã–ª–∫–∞/—Ñ–∞–π–ª) —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.")
            except Exception as e:
                logger.exception("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∞ –æ–ø—Ä–æ—Å–∞: %s", e)
                await update.message.reply_text("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.")
            context.user_data.pop("state", None)
        else:
            await update.message.reply_text("–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø—Ä–æ—Å (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å http) –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª.")
        return
    
    # --- –û–±—ã—á–Ω–æ–µ –º–µ–Ω—é ---
    if text.lower() in ['–º–µ–Ω—é', 'menu', '–Ω–∞—á–∞—Ç—å', '–∫—Å—Ç']:
        await menu(update, context)
    elif text.lower() in ['–æ–±—ä—è–≤–ª–µ–Ω–∏—è', 'announcements', '–Ω–æ–≤–æ—Å—Ç–∏']:
        await announcements_command(update, context)
    elif text.lower() in ['–ª–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π', '–Ω–æ–≤–æ—Å—Ç–∏ –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤', 'newsfeed']:
        await newsfeed_command(update, context)
    else:
        result = get_reply_for_menu_button(text)
        if result:
            msg_text, inline_kb = result
            if text == "–ü–ï–î–ê–ì–û–ì–ê–ú":
                if not database.is_pedagog_registered(user_id):
                    msg_text = (
                        "<b>–ü–ï–î–ê–ì–û–ì–ê–ú</b>\n\n"
                        "–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞–∑–¥–µ–ª—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.\n\n"
                        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
                    )
                    inline_kb = InlineKeyboardMarkup([
                        [InlineKeyboardButton("üîê –í–æ–π—Ç–∏", callback_data='pedagog_login')],
                        [InlineKeyboardButton("üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", callback_data='pedagog_register')],
                        [InlineKeyboardButton("‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_main')]
                    ])
                elif not context.user_data.get("pedagog_logged_in"):
                    msg_text = (
                        "<b>–ü–ï–î–ê–ì–û–ì–ê–ú</b>\n\n"
                        "–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ —Å–≤–æ–∏–º –ø–∞—Ä–æ–ª–µ–º:"
                    )
                    inline_kb = InlineKeyboardMarkup([
                        [InlineKeyboardButton("üîê –í–æ–π—Ç–∏", callback_data='pedagog_login')],
                        [InlineKeyboardButton("‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_main')]
                    ])
            elif text == "–°–¢–£–î–ï–ù–¢–ê–ú":
                if not database.is_student_registered(user_id):
                    msg_text = (
                        "<b>–°–¢–£–î–ï–ù–¢–ê–ú</b>\n\n"
                        "–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å? –ù–∞–∂–º–∏—Ç–µ <b>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</b> ‚Äî —Å–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é —É—á—ë—Ç–Ω—É—é –∑–∞–ø–∏—Å—å.\n\n"
                        "–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –ù–∞–∂–º–∏—Ç–µ <b>–í–æ–π—Ç–∏</b>."
                    )
                    inline_kb = InlineKeyboardMarkup([
                        [InlineKeyboardButton("üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", callback_data='student_register')],
                        [InlineKeyboardButton("üîê –í–æ–π—Ç–∏", callback_data='student_login')],
                        [InlineKeyboardButton("‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_main')]
                    ])
                elif not context.user_data.get("student_logged_in"):
                    msg_text = (
                        "<b>–°–¢–£–î–ï–ù–¢–ê–ú</b>\n\n"
                        "–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ —Å–≤–æ–∏–º –ø–∞—Ä–æ–ª–µ–º:"
                    )
                    inline_kb = InlineKeyboardMarkup([
                        [InlineKeyboardButton("üîê –í–æ–π—Ç–∏", callback_data='student_login')],
                        [InlineKeyboardButton("‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_main')]
                    ])
            await update.message.reply_text(
                msg_text,
                reply_markup=inline_kb,
                parse_mode='HTML'
            )
        else:
            await update.message.reply_text(
                "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é –ö–°–¢ ‚ö°Ô∏è –∏–ª–∏ –∫–æ–º–∞–Ω–¥—É /menu.",
                reply_markup=get_main_menu_keyboard()
            )

# ========== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==========
def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
        database.init_db(CONFIG_DIR)
        logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º–∏ —Ç–∞–π–º–∞—É—Ç–∞–º–∏
        logger.info("–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –±–æ—Ç–∞...")
        application = (
            Application.builder()
            .token(TOKEN)
            .post_init(post_init)
            .connect_timeout(30.0)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–æ 30 —Å–µ–∫—É–Ω–¥
            .read_timeout(30.0)     # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç —á—Ç–µ–Ω–∏—è –¥–æ 30 —Å–µ–∫—É–Ω–¥
            .write_timeout(30.0)    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –∑–∞–ø–∏—Å–∏ –¥–æ 30 —Å–µ–∫—É–Ω–¥
            .pool_timeout(30.0)      # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –ø—É–ª–∞ –¥–æ 30 —Å–µ–∫—É–Ω–¥
            .build()
        )
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
        application.add_handler(CommandHandler("start", start))
        application.add_handler(CommandHandler("restart", restart_command))
        application.add_handler(CommandHandler("menu", menu))
        application.add_handler(CommandHandler("help", help_command))
        application.add_handler(CommandHandler("about", about))
        application.add_handler(CommandHandler("announcements", announcements_command))
        application.add_handler(CommandHandler("newsfeed", newsfeed_command))
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫
        application.add_handler(CallbackQueryHandler(button_handler))
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        print("=" * 50)
        print("ü§ñ –ë–û–¢ –ö–°–¢ ‚ö°Ô∏è")
        print("=" * 50)
        print("üì± –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –≤ Telegram")
        print(f"üì¢ –ö–∞–Ω–∞–ª –æ–±—ä—è–≤–ª–µ–Ω–∏–π: {ANNOUNCEMENTS_CHANNEL_USERNAME}")
        print(f"üì∞ –ö–∞–Ω–∞–ª –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤: {NEWS_FEED_CHANNEL_USERNAME}")
        print("=" * 50)
        print("‚ö°Ô∏è –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram API...")
        logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
        
        # –ó–∞–ø—É—Å–∫ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        max_retries = 5
        retry_count = 0
        retry_delay = 5  # —Å–µ–∫—É–Ω–¥
        
        while retry_count < max_retries:
            try:
                application.run_polling(
                    allowed_updates=Update.ALL_TYPES,
                    drop_pending_updates=True,
                    close_loop=False,
                    bootstrap_retries=5  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                )
                break  # –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
            except TimedOut as e:
                retry_count += 1
                logger.warning(f"–¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–ø–æ–ø—ã—Ç–∫–∞ {retry_count}/{max_retries}): {e}")
                if retry_count < max_retries:
                    print(f"‚è≥ –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ {retry_delay} —Å–µ–∫—É–Ω–¥...")
                    print("üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ")
                    time.sleep(retry_delay)
                    retry_delay = min(retry_delay * 2, 60)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É, –Ω–æ –Ω–µ –±–æ–ª–µ–µ 60 —Å–µ–∫
                else:
                    print("\n" + "=" * 50)
                    print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Telegram API –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫")
                    print("=" * 50)
                    print("\nüîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
                    print("   ‚Ä¢ –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è")
                    print("   ‚Ä¢ Telegram API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞/–ø—Ä–æ–±–ª–µ–º—ã –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Telegram)")
                    print("   ‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∫—Å–∏/—Ñ–∞–π—Ä–≤–æ–ª–æ–º")
                    print("   ‚Ä¢ –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞")
                    print("\nüí° –†–µ—à–µ–Ω–∏—è:")
                    print("   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ")
                    print("   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∫—Å–∏/—Ñ–∞–π—Ä–≤–æ–ª–∞")
                    print("   ‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–∑–∂–µ")
                    print("   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN")
                    logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫: {e}")
                    raise
            except NetworkError as e:
                retry_count += 1
                logger.warning(f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ (–ø–æ–ø—ã—Ç–∫–∞ {retry_count}/{max_retries}): {e}")
                if retry_count < max_retries:
                    print(f"üåê –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ {retry_delay} —Å–µ–∫—É–Ω–¥...")
                    time.sleep(retry_delay)
                    retry_delay = min(retry_delay * 2, 60)
                else:
                    print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Telegram API")
                    logger.error(f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫")
                    raise
            except RetryAfter as e:
                logger.warning(f"–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –û–∂–∏–¥–∞–Ω–∏–µ {e.retry_after} —Å–µ–∫—É–Ω–¥...")
                print(f"‚è∏ –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –û–∂–∏–¥–∞–Ω–∏–µ {e.retry_after} —Å–µ–∫—É–Ω–¥...")
                time.sleep(e.retry_after)
                retry_count = 0  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ RetryAfter
            except Conflict:
                print("\n" + "=" * 50)
                print("‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç: —É–∂–µ –∑–∞–ø—É—â–µ–Ω –¥—Ä—É–≥–æ–π —ç–∫–∑–µ–º–ø–ª—è—Ä —ç—Ç–æ–≥–æ –±–æ—Ç–∞.")
                print("=" * 50)
                print("\nüí° –ó–∞–ø—É—Å–∫–∞—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –û–î–ò–ù —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ —Å –æ–¥–Ω–∏–º —Ç–æ–∫–µ–Ω–æ–º.")
                print("   ‚Ä¢ –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–æ–π —Ç–µ—Ä–º–∏–Ω–∞–ª/–æ–∫–Ω–æ, –≥–¥–µ –∑–∞–ø—É—â–µ–Ω –±–æ—Ç")
                print("   ‚Ä¢ –ò–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ/–¥—Ä—É–≥–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ")
                print("   ‚Ä¢ –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ —Å–Ω–æ–≤–∞")
                logger.warning("Conflict: –¥—Ä—É–≥–æ–π —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ —É–∂–µ –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
                sys.exit(1)
            except KeyboardInterrupt:
                print("\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...")
                logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
                break
            except Exception as e:
                logger.exception(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")
                print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
                raise
                
    except Exception as e:
        logger.exception(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ main(): {e}")
        print(f"\n‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {e}")
        print("\nüí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:")
        print("   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ")
        print("   2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π")
        print("   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ Telegram –≤ –≤–∞—à–µ–π —Å–µ—Ç–∏")
        print("   4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VPN –∏–ª–∏ –ø—Ä–æ–∫—Å–∏")
        sys.exit(1)

if __name__ == '__main__':  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: name -> __name__
    main()